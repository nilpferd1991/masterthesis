\newcommand{\dedx}{$\mathrm d E / \mathrm d x$ }
\chapter{Momentum estimation of slow pions with the ADC in the VXD}

\todo{Path length MC = Calculated as in algorithm!}
\todo{Include correct new pictures}

When looking onto the typical momentum distribution of the particles flying through the tracking detectors as show in figure \ref{fig-particles-momentum} it is clear that there is a significant amount of so called slow pions with momenta in the order of $\unit[100]{MeV}$. These particles get produced more or less at the interaction point and because of their small momentum and therefore high curvature and their huge energy losses they can not be detected in the CDC tracking detector. This means they can only be measured in the VXD. Because of the small radius of the VXD and the resulting small number of independent measurement points, the momentum resolution is very poor as it can be seen in the Glückstern formula
\begin{align*}
 \frac{\sigma_{p_T}}{p_T} = \sqrt{\frac{720}{N + 4}} \sigma_x \frac{p_T \text{[GeV]}}{0.3 q B \text{[T]} L^2}
\end{align*}
where L is the length of the track in the detector and $N$ is the number of measurement points. Decreasing the magnetic field would decrease the curvature of the low momentum pions and would therefore make them detectable in the CDC also increasing the number of measurement points. But this would also make the resolution of the high momentum particles very poor. In this thesis a different approach is chosen. Together with the measured positions for each found VXD sensor hit an independent momentum estimation based on the energy loss per length of the particles in this sensor is calculated and used in the trajectory fit after the track finding. These added measurements bias the fit towards the correct momentum and can therefore help to increase the momentum resolution.

\begin{figure}
 \centering
 \includegraphics[width=0.8\linewidth]{figures/vxd/momentumDistribution.png}
 \caption{Momentum distribution split by different particle types as generated by the simulation. As this simulation is modeled after the physical branching fractions the here shown distribution is also the expected observation in the experiment.}
 \label{fig-particles-momentum}
\end{figure}

As it was shown in previous studies \cite{robert}, the momentum resolution compared to the result of the helix fit with the positions only can be increased by using the information from the energy loss of all hits in the track together. In the quoted paper an advanced summation was used to build a mean energy loss of the slow pions which was transformed to a momentum by a predetermined formula. This momentum estimation was then compared to the one coming from the helix fit. To increase the resolution even more the two different approaches are combined in the presented algorithm.

In figure \ref{fig-dedx-over-p} the energy loss per travel length in the VXD sensors for low momentum pions is shown. How these numbers are calculated is described in the next sections. As it can be seen the \dedx increases with falling momentum of the particles. This relation can be also seen in the already quoted Bethe formula \ref{form-bethe} in chapter \ref{chapter-ex} which can be reduced to 
\begin{align}
 -\left \langle \dd{E}{x} \right\rangle \approx \frac{4 \pi n z^2}{m_e v^2} \left( \frac{e^2}{4 \pi \varepsilon_0} \right)^2 \ln \left( \frac{2 m_e v^2}{I} \right) \label{form-bethe-simpl}
\end{align} \todo{see in chapter 1: described mean?}
for small particle energies. The equation can be used to calculate the momentum using the energy loss per travel length. But as this formula describes the averaged energy loss it is only correct for a small number of cases. The variance in the energy loss is distributed according to a landau distribution which is described later in more detail. This deviation from the Bethe formula decreases the momentum resolution of the estimation based on the energy loss.

\begin{figure}
 \centering
 \includegraphics[width=0.8\linewidth]{figures/vxd/dedx.png}
 \caption{\dedx information of the VXD clusters of approximately 100000 pions in the momentum range from 50 to 120 MeV. The averaged energy loss can be described by the Bethe formula. The distribution of energy losses for a given momentum is distributed according to a landau distribution which is described later in more detail. To transform the \dedx value to a momentum the red estimator curve is used later.}
 \label{fig-dedx-over-p}
\end{figure}


\section{Prestudies on the distribution of dE/dX in the VXD}

For the following studies an event sample of slow pions in the momentum range between $\unit[50]{MeV}$ and $\unit[120]{MeV}$ is used. It is simulated using the particle gun with 10 particles per event evenly distributed among the momentum range and between the two charge modes. The sample is split into different event samples for testing and fitting. The standalone VXD track finder or the MC track finder for reference is used to create tracks out of the simulated VXD hits. As the finding efficiency of the standalone VXD track finder depends heavily on the momenta of the particles, the distribution of the found tracks is not flat any more as it can be seen in figure \ref{fig-vxd-finding-efficiency}. A typical event display can be seen in picture \ref{fig-vxd-event-display}.

\begin{figure}
 \centering
 \includegraphics[width=0.48\linewidth]{figures/vxd/finding_efficiency.png}
 \includegraphics[width=0.48\linewidth]{figures/vxd/finding_efficiency.png}
 \todo{correct picture}
 \caption{Momentum distribution of the simulated pions as found by the VXD track finder (left) and the MC track finder (which has the simulated truth information, right). The finding efficiency decreases with lower momenta as the number of hits in the VXD is lower for slow pions and the energy loss is stronger. The MC track finder has also not a flat distribution of momenta as it only uses those particles for tracks which have at least 3 hits in the VXD detector.}
 \label{fig-vxd-finding-efficiency}
\end{figure}

\begin{figure}
 \centering
 \caption{Typical event display of one event used for analyzing the momentum estimation for the fitting procedure in the helix fit.}
 \label{fig-vxd-event-display}
 \todo{picture}
\end{figure}

Before calculating the function to transform the \dedx value to a momentum estimation and using this information in the helix fit some prestudies are performed to check for the consistency of the input data. They are shown here for reference too.

For calculating the path length used in \dedx the correct position of the hit and the sensor information is needed. This information is provided by the clusters used in the track finder. Its results can be seen in figure \ref{fig-cluster-position} where the distance to the beam pipe over the z position is shown for some SVD hits. This position is later used to calculate the path length of the tracks in the sensor region.

\begin{figure}
 \centering
 \includegraphics[width=0.8\linewidth]{figures/vxd/cluster_positions.png}
 \caption{Picture showing the simulated hit information of the first 1000 clusters in the event sample. The color code separates between the sensor ID property of the clusters.}
 \label{fig-cluster-position}
\end{figure}

Instead of using the deposited charge in every sensor directly the ADC count value of every sensor is used. This ADC count comes directly from the digitalization process and does therefore not rely on any calibration process. As it is directly proportional to the deposited energy and the parameters of the transformation function from \dedx to the momentum have to be determined by a fit in either way, the ADC count is used as a measure for the energy deposition. Picture \ref{fig-adc-count} shows the the \dedx value calculated with this ADC count for the two different detectors SVD and PXD. As it can be seen, the calibration coefficients to the correct deposited energy are different for the two detectors and therefore the two distributions are not superimposable. To cope with this fact the ADC counts coming from the PXD sensors get multiplied by a factor of 0.653382 which was calculated on data. The resulting distribution is shown in the right subplot of figure \ref{fig-adc-count}.

\begin{figure}
  \centering
 \includegraphics[width=0.48\linewidth]{figures/vxd/dEdXUncalibrated.png}
 \includegraphics[width=0.48\linewidth]{figures/vxd/dEdXCalibrated.png}
 \caption{Distributions of the uncalibrated (left) and the calibrated (right) ADC counts of the PXD and SVD hits. Only clusters found by the VXD track finder are shown here.}
 \todo{Correct}
 \label{fig-adc-count}
\end{figure}

\subsection{Calculation of the path length in the clusters}
The \dedx value in every cluster can be calculated using the calibrated charge as described above and the length of the path the trajectory travels in the sensor region. There are five ways to calculate this path length. All of them are implemented in the code basis.
\begin{zlist}
 \item Using the correct (simulated) MC trajectory information of the tracks at the position of the clusters, \label{list-mc}
 \item Using the current trajectory parameters while fitting,
 \item Using the related MC trajectory at the origin,
 \item Using the trajectory parameters estimated by the track finder without MC truth information,
 \item Using the thickness of the cluster.
\end{zlist}

The different possibilities are ordered by their anticipated correctness. The two MC modes are only implemented for reference as they can obviously not be used in the later detector measurement. How the current trajectory parameters are deduced in the fit is described later.

Besides the last possibilities all modes rely on calculating the path length of a trajectory using their helix parameters. As the calculated path lengths are very small, this is done without taking into account energy loss or material effects. The procedure is as follows:
\begin{zlist}
 \item Take the position of the cluster hit (the point where the trajectory enters the VXD sensor) and calculate the distance to the beam line. This is called the inner radius of the cluster.
 \item Add the sensor thickness to this radius to gain an estimation of the outer radius of the sensor.
 \item Calculate the arc length between these two radii and from this arc length the distance between the two penetration points of the helix through the sensor using trigonometrical relations.
\end{zlist}

This procedure is correct for most of the time but fails in some rare cases. Some examples are shown in figure \ref{fig-errors-in-path-length}. As it can be seen in the pictures, errors in the calculation occur mainly for particles which have their apogee\footnote{The apogee is the opposite to the perigee - the point on the helical trajectory the most far away from the interaction point} in the sensors. As the VXD sensors have only a very thin thickness the probability for such particles is very rare. Therefore - as seen later - these cases do not bias the momentum measurement much. Also as the calculation error can only occur in the most outer sensor touched by the particles all other sensors give correct momentum estimations. \todo{Percentage!}

\begin{figure}
  \centering
  \raisebox{-0.5\height}{\includegraphics[scale=0.3]{figures/vxd/pathlength1.pdf}}
  \hspace*{1.5cm}
  \raisebox{-0.65\height}{\includegraphics[scale=0.3]{figures/vxd/pathlength3.pdf}}
  \hspace*{0.5cm}
  \raisebox{-0.5\height}{\includegraphics[scale=0.3]{figures/vxd/pathlength4b.pdf}}
  \caption{Exemplary cases of path length calculations. The algorithm fails in the second and last case. In the second case it returns the width or the length of the sensor instead. In the last case it wrongly adds the orange part of the path length to the correct one. Because of the geometrical dimensions of the sensors these two cases are very rare.}
  \label{fig-errors-in-path-length}
\end{figure}

In figure \ref{fig-pathlengths} the distribution of the path lengths from the simulated MC truth values is shown. As most of the particles go more or less straight through the sensors, there are two peaks in the distribution - one for each hit type as the two types PXD and SVD have a different thickness. Deviations from the thickness come from curling particles. The fact that there are only few tracks with very high deviations from the thickness values verifies th claim that the helix calculation is wrong only for very rare cases.

The second subplot shows the distribution of the residuals of the other four path length calculations to these reference values as a violin plot.

\todo{Beschreibung!}

\begin{figure}
 \centering
  \includegraphics[width=0.5\linewidth]{figures/vxd/pathlengthHitType.png}
  \todo{missing plot}
 \caption{The left plot shows the path length distribution for the two sensor types as a result of the simulation. This distribution is used for reference in the right plot which shows the residuum distribution of the other path length calculation modes.}
 \label{fig-pathlengths}
\end{figure}

\subsection{Transformation function from dE/dX to momentum}

For calculating a momentum estimation from the \dedx value the inverted function of equation \ref{form-bethe-simpl} is needed which can not be calculated analytically. Therefore a much easier model function
\begin{align}
 p(\mathrm{d}E/\mathrm{d} x) = \frac{a}{(\mathrm{d}E/\mathrm{d} x - b)^2} + c \cdot \mathrm{d}E/\mathrm{d} x + d \label{form-model}
\end{align}
with the free parameters $a, b, c$ and $d$ is fitted to the \dedx-momentum-values where \dedx is calculated with path lengths from mode (\ref{list-mc}) and the momentum is taken from the MC simulation at this cluster (so including energy loss by material effects).

The fitting parameters can not be determined by fitting the model function to the whole distribution at once as shown for example in figure \ref{fig-dedx-over-p}. The reason is that because of the landau distributed energy loss the number of outliers is too high and caused the fit to fail. An example of the landau distribution showing the large amount of outliers deviating from the mean energy loss is shown in picture \ref{fig-landau}. This is why a reduce approach is chosen here: First the \dedx-range is split into several small bins. In each of them the momentum distribution is build. This distribution is then fitted with a landau or a normal distribution. Mathematically the momentum distribution in these \dedx-bins is neither distributed according to a landau nor a normal distribution but the correct form can not be calculated analytically and these two distributions describe the data best.\footnote{The correct form of the distribution can be calculated by integrating over parts of the landau distribution folded with the inverted Bethe-equation.} The resulting parameters of the distributions (the mean of the gauß or the location parameter of the landau distribution\cite{landau}) are then used for fitting the model function \ref{form-model}. The whole process can be seen in figure \ref{fig-fit-bins}.

\todo{pictures: landau, git-bins}
\todo{correction?}

For the incorporation of the gained momentum estimation into the helix fit of genfit, not the momentum value directly but $q/p$ is needed. This is why in the following the residuum of $p^{-1}$ instead of $p$ is presented.

In the two subplots of figure \ref{fig-divp-residdum} the median and the interquartile range of the residuum of the estimated to the MC momentum is shown. As both fit functions (gauß and landau) lead to quite large shifts in the median indicating a biased momentum estimation a correction procedure is introduced: a cubic polynomial is fitted to the median values which is later subtracted from the momentum estimation. These corrected estimators are also shown in the figure.

Besides the here presented two methods to gain the estimator function $p(\mathrm dE/\mathrm dx)$, also other fit models instead of equation \ref{form-model}, other fit functions instead of landau and gauß and totally different methods like a boosted decision tree for regressions where tested. As all of these methods show worse results, they are not presented here. They can be easily compared to the mentioned results by using the IPython notebooks written by the author of this thesis.

\section{Incorporation in the helix fit}

Before describing the results of the momentum resolution with and without the new momentum estimation, the incorporation of this new measurement type is described shortly. For this, the measurement model used in genfit is summarized here briefly. More information can be found elsewhere \cite{genfit}.

MeasurementCreator, State On Plane -> TrackPoint

Results with fit, p value, iqr, median

Pictures:
- residuum, median + iqr function for different path length calculations
- p values